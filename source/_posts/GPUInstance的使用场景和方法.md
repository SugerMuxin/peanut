---
title: GPUInstance的使用场景和实现方法
comments: true
published: true
tags: 
  -Unity
  -Game

---

####   <span style="color:green;">1 . 为什么要用GPU Instance</span>

>在没有GPUInstance此技术之前，对于像草地、树木，割草游戏，它们往往是数据量很大，但同时又只存在微小的差别如位置、旋转、颜色等。如果像常规物体那样进行渲染，所使用的绘制指令必然很多，资源占用必然很大，一是cpu对gpu提交数据的次数（包括设置数据buffer，渲染状态以及调用对渲染原语的绘制即drawcall），二是gpu上的绘制（包括顶点处理和像素绘制），随着场景物体的提升，cpu和gpu的压力都会上升。一个合理的策略就是，我们指定一个需要绘制物体对象，以及多个不同的参数，然后根据参数在一个绘制调用中绘制出来——这就是所谓的GPU实例化。
>适用场景：场景中同质化角色非常多的情况。


### <span style="color:green;">2 . GPU Instance 原理 </span>

>Gpu Instance就是用来解决这一问题的，对于使用 同一网格 和 同一材质的物体们，它使用少量的渲染调用(DrawCall)，渲染同一网格的多个副本，也就是说在渲染时， CPU 可以把 它们的不同的属性(位置，大小，旋转，颜色等) 和 其它Instancing 材质信息组装成一个 Buffer(实际上就是一个数组) 传给 GPU 的一个缓存区。GPU 在渲染这些物体时，会有一个 全局的 SV_InstanceID 即 数组的 下标，每渲染完一个物体就 ++SV_InstanceID，这样我们每个物体就可以根据这个 id 拿到自己的 位置颜色等信息啦。这样我们渲染这些物体时就只需要一个 DrawCall 即将 数组 传给 GPU 缓存区，就可以渲染大量的物体。


### <span style="color:green;">3.实现的步骤</span>
>1. 将所有动画的顶点数据烘焙到两张张贴图下，我们称之为顶点贴图和法线贴图。
>2. 当在shader的顶点着色器中通过采样顶点贴图和法线贴图（这里需要注意的线性空间需要进行一个反gama的操作）
>3. 关于动画的生命周期和切换的时间需要再角色的挂载脚本的update中去维护。当然这里肯定有很多的update，所以应该添加一个容器来管理这些角色的脚本对象，这样只需要维护一个update

